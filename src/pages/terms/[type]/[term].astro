---
export interface Params {
  type: 'categories' | 'tags';
  term: string;
}

import BaseLayout from "../../../layouts/BaseLayout.astro";
import { sortTerms } from "../../../utils/sortTerms";
import { hashTitle } from "../../../utils/hashTitle";

export async function getStaticPaths() {
  const postFiles = import.meta.glob('../../../blog/*.{md,mdx}', { eager: true });
  const categorySet = new Set<string>();
  const tagSet = new Set<string>();

  for (const path in postFiles) {
    const fm = (postFiles[path] as any).frontmatter;
    fm.categories?.forEach((c: string) => categorySet.add(c));
    fm.tags?.forEach((t: string)       => tagSet.add(t));
  }

  return [
    ...Array.from(categorySet).map(category => ({
      params: { type: 'categories', term: encodeURIComponent(category) },
    })),
    ...Array.from(tagSet).map(tag => ({
      params: { type: 'tags',       term: encodeURIComponent(tag) },
    })),
  ];
}

const { type, term } = Astro.params;
const decoded = decodeURIComponent(term);

const postFiles = import.meta.glob('../../../blog/*.{md,mdx}', { eager: true });
const posts = Object.entries(postFiles).map(([_, mod]: any) => {
  const fm = mod.frontmatter;
  const date = fm.date.replace(/-/g, '').slice(0, 8);
  const hash = hashTitle(fm.title);
  const slug = fm.slug || `${date}-${hash}`;
  return { frontmatter: fm, url: `/blog/${slug}` };
});

const key      = type === 'categories' ? 'categories' : 'tags';
const filtered = posts.filter(p => p.frontmatter[key]?.includes(decoded));
filtered.sort((a, b) => b.frontmatter.date.localeCompare(a.frontmatter.date));

const label     = type === 'categories' ? 'Category' : 'Tag';
const pageTitle = `${label}: ${decoded}`;
---
<BaseLayout pageTitle={pageTitle}>
  <div class="max-w-3xl mx-auto px-8 py-16 w-full">
    <h1 data-scramble class="text-3xl font-bold mb-6">{pageTitle}</h1>
    {filtered.length > 0 ? (
      <ul class="space-y-4">
        {filtered.map(({ frontmatter, url }) => (
          <li>
            <a
              href={url}
              class="block bg-[var(--color-bg)] border border-[var(--color-border)]
                     rounded-xl p-6 transition-all duration-200 ease-in-out
                     hover:translate-x-[-4px] hover:translate-y-[-4px]
                     hover:shadow-[4px_4px_0_var(--color-accent)]
                     hover:border-[var(--color-accent)]"
            >
              <div class="flex flex-wrap items-center gap-2 mb-4">
                <time
                  class="text-sm text-[var(--color-subtext)]"
                  datetime={frontmatter.date}
                >
                  {frontmatter.date.slice(0, 10)}
                </time>
                {frontmatter.categories && sortTerms(frontmatter.categories).map(c => (
                  <span class="bg-[var(--color-accent)] text-stone-50 px-2 py-0.5 rounded text-xs">
                    {c}
                  </span>
                ))}
                {frontmatter.tags && sortTerms(frontmatter.tags).map(t => (
                  <span class="border border-[var(--color-accent)] text-[var(--color-accent)]
                               px-2 py-0.5 rounded text-xs">
                    {t}
                  </span>
                ))}
              </div>
              <h2 class="text-xl font-semibold">{frontmatter.title}</h2>
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <p>No posts found.</p>
    )}
  </div>
</BaseLayout>
